name: Deploy to Cloud Run

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set project & export creds
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          export_default_credentials: true

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker --quiet

      - name: Debug computed tags
        run: |
          echo "GCP_PROJECT='${{ secrets.GCP_PROJECT }}' (length: $(echo -n "${{ secrets.GCP_PROJECT }}" | wc -c))"
          echo "IMAGE_NAME='${{ env.IMAGE_NAME }}'"
          echo "GITHUB_SHA='${{ github.sha }}' (length: $(echo -n "${{ github.sha }}" | wc -c))"
          echo "Tags:"
          echo "  gcr.io/${{ secrets.GCP_PROJECT }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "  gcr.io/${{ secrets.GCP_PROJECT }}/${{ env.IMAGE_NAME }}:latest"

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          push: true
          tags: |
            gcr.io/${{ secrets.GCP_PROJECT }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            gcr.io/${{ secrets.GCP_PROJECT }}/${{ env.IMAGE_NAME }}:latest

      - name: Deploy to Cloud Run (robust)
        shell: bash
        env:
          # Trim any trailing newline/CR LF from secrets to avoid accidental newlines:
          PROJECT_ID: ${{ secrets.GCP_PROJECT }}
          REGION: ${{ secrets.GCP_REGION }}
          SHA: ${{ github.sha }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
        run: |
          set -xeuo pipefail

          # Trim CR/LF from secrets (in case they were saved with trailing newline)
          PROJECT_ID_CLEAN=$(printf "%s" "$PROJECT_ID" | tr -d '\r\n')
          REGION_CLEAN=$(printf "%s" "$REGION" | tr -d '\r\n')
          SHA_CLEAN=$(printf "%s" "$SHA" | tr -d '\r\n')

          IMAGE="gcr.io/${PROJECT_ID_CLEAN}/${IMAGE_NAME}:${SHA_CLEAN}"

          echo "About to run: gcloud run deploy backend --image=\"$IMAGE\" --region=\"$REGION_CLEAN\" --platform=managed --allow-unauthenticated"
          # Run the deploy as a single command (quoted to avoid accidental splitting)
          gcloud run deploy backend \
            --image="$IMAGE" \
            --region="$REGION_CLEAN" \
            --platform=managed \
            --allow-unauthenticated
